<HTML>
<HEAD>
<TITLE>student_1/</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
student_2/<p><PRE>
&gt;&gt;&gt;&gt; file: parallebubblesort.c
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;time.h&gt;
#include &lt;sys/time.h&gt;
#include &lt;sys/ipc.h&gt;
#include &lt;sys/shm.h&gt;
#include &lt;assert.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#define SHM_SIZE 1024000
#define MAX_VALUE 1000
#define MAX_COUNT 100000 
#define MAX_PROCESS 100 


typedef struct Data
{
	int N,pass,swap[MAX_PROCESS],state[MAX_PROCESS],data[MAX_COUNT];
}Data;


void print_numbers(Data *data){
    int i=0;
	while(i&lt;data-&gt;N){ printf("%d ", data-&gt;data[i]);i++; }
	printf("\n");
}

Data* create(int N){
    
	int shmid;
	Data *data;
	if((shmid = shmget(IPC_PRIVATE, SHM_SIZE, 0644 | IPC_EXCL)) == -1){
		perror("shmget failed");
		exit(1);
	}
	data = shmat(shmid, (const void *)0, 0);
	data-&gt;pass = 0;data-&gt;N = N;
    srandom(time(NULL));
	for(int i = 0; i &lt; N; i++){
	    data-&gt;state[i] = 1;
		data-&gt;data[i] = random() % MAX_VALUE;
		data-&gt;swap[i] = 0;
	}
	return data;
}


int compare_and_swap(int *number, int i, int N, int j)
{
	assert ( i&lt;N );
	assert ( j&lt;N );

	if( number[i] &gt; number[j]) {
		long temp = number[i];
		number[i] = number[j];
		number[j] = temp;
		return 1;
	}

	return 0;
}


void bubble(Data *data, int start, int n, int pid) 
{
	if(start + n &gt; data-&gt;N)
		n = data-&gt;N - start;
	while(data-&gt;state[pid] != -1){
		if(data-&gt;state[pid]){
			int swap_count = 0;
			int next = start;
			assert (start &lt; data-&gt;N-1); // bug if we start at the end of array
<A NAME="1"></A><FONT color = #00FF00><A HREF="match24-0.html#1" TARGET="0"><IMG SRC="http://moss.stanford.edu/bitmaps/tm_1_3.gif" ALT="other" BORDER="0" ALIGN=left></A>

			if (data-&gt;pass) { // sort odd-even index pairs
				if ( !(next % 2) ) 
					next = next + 1;
			} else  { // sort even-odd index pairs
				if (next % 2) 
					next = next + 1;
			}
			while ( (next+1) &lt; (start+n) ) {
</FONT>				swap_count += compare_and_swap(data-&gt;data, next, data-&gt;N,next+1);
				next+=2;
			}
			data-&gt;swap[pid] = swap_count;
			data-&gt;state[pid] = 0;
		}
	}
}


void bubble_sort(Data *data, int P)
{
	int last_count, swap_count = data-&gt;N;

	struct timeval start,end;
	gettimeofday(&start, NULL);

	do{
		last_count = swap_count;
		int res = 0,i = 0;
	    while(i&lt;P){res += data-&gt;state[i];i++;}
		if( !(res)){
			int asb = 0,x = 0;
	        while(x&lt;P){asb += data-&gt;swap[x];x++;}
			swap_count = asb;
			data-&gt;pass = 1 - data-&gt;pass;
			for(int i = 0; i &lt; P; i++){data-&gt;state[i] = 1;data-&gt;swap[i] = 0;}
		}
	} while((swap_count!=0) || (last_count != 0));
	
	for(int i = 0; i &lt; P; i++){data-&gt;state[i] = -1;}
	
	gettimeofday(&end, NULL);
	double elapsed = (end.tv_sec - start.tv_sec) + 
              ((end.tv_usec - start.tv_usec)/1000000.0);
	fprintf(stderr, "time took for sorting is %f milliseconds.\n", elapsed);

}


int main(int argc, char* argv[]){
	
	if(argc != 3){
		fprintf(stderr, "Usage: %s N P\n", argv[0]);
		return 1; 
	}
	int N = strtol(argv[1], (char **)NULL, 10);
<A NAME="0"></A><FONT color = #FF0000><A HREF="match24-0.html#0" TARGET="0"><IMG SRC="http://moss.stanford.edu/bitmaps/tm_0_5.gif" ALT="other" BORDER="0" ALIGN=left></A>

	int P = strtol(argv[2], (char **)NULL, 10);
	if( (N &lt; 2) || (N &gt; MAX_COUNT) ) {
		fprintf(stderr, "Invalid N. N should be between 2 and %d.\n", MAX_COUNT);
		return 2;
	}
	if( (P &lt; 2) || (P &gt; MAX_PROCESS) ) {
		fprintf(stderr, "Invalid P. P should be between 2 and %d.\n", MAX_PROCESS);
		return 3;
</FONT>	}
	printf("creating Shared Memory\n");
	Data *data = create(N);
	fprintf(stderr, "Generated sequence is as follows:\n");
	print_numbers(data);
	int range = N/P + 1;
	for(int i = 0; i &lt; P; i++){
		int pid = fork();
		if(pid &lt; 0){
			perror("fork");
			exit(1);
		}
		else if(pid == 0){
			fprintf(stderr, "%dth child process, with pid  %d.\n", i+1,getpid());
			bubble(data, i*(range-1), range, i);
			exit(0);
		}
	}
	
	bubble_sort(data, P);
	fprintf(stderr, "Sorted sequence is as follows:\n");
	print_numbers(data);
     printf("Detaching Shared Memory\n");
    if (shmdt(data) == -1) {
            perror("shmdt");
            exit(1);
        }
    printf("Shared Memory Detached\n");
	return 0;
}
</PRE>
</PRE>
</BODY>
</HTML>
