<HTML>
<HEAD>
<TITLE>student_1/</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
student_6/<p><PRE>
&gt;&gt;&gt;&gt; file: Parallel_bubblesort.c


#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;sys/ipc.h&gt;
#include &lt;sys/shm.h&gt;
#include &lt;sys/time.h&gt;
#include &lt;time.h&gt;
#include&lt;assert.h&gt;

#define MAX_COUNT 100
#define MAX_NUM 100
#define MAX_P 10

int N,P; //N - Number of integers to sort P -Number of Process


typedef struct Data
{
	int pass;
	long num[MAX_COUNT];
	int state[MAX_P];
	int swap[MAX_P];

}Data;

int compare_and_swap(Data *data, int i, int j)
{
<A NAME="0"></A><FONT color = #FF0000><A HREF="match9-0.html#0" TARGET="0"><IMG SRC="http://moss.stanford.edu/bitmaps/tm_0_8.gif" ALT="other" BORDER="0" ALIGN=left></A>

	assert ( i&lt;N );
	assert ( j&lt;N );

	if( data-&gt;num[i] &gt; data-&gt;num[j]) {
		long temp = data-&gt;num[i];
		data-&gt;num[i] = data-&gt;num[j];
		data-&gt;num[j] = temp;
		return 1;
	}

	return 0;
}

void generate_numbers(Data *data)
</FONT><A NAME="3"></A><FONT color = #00FFFF><A HREF="match9-0.html#3" TARGET="0"><IMG SRC="http://moss.stanford.edu/bitmaps/tm_3_4.gif" ALT="other" BORDER="0" ALIGN=left></A>

{
	int i;

	srand(time(NULL));
	for (i = 0; i &lt; N; i++)
	{
		data-&gt;num[i] = rand() % MAX_NUM;
	}
}

void print_numbers(Data *data2)
</FONT>{
	int i;

	for (i = 0; i &lt; N; i++)
	{
		printf("%ld ", data2-&gt;num[i]);
	}
}

void stateChange(Data *data,int value){
	int i;
<A NAME="1"></A><FONT color = #00FF00><A HREF="match9-0.html#1" TARGET="0"><IMG SRC="http://moss.stanford.edu/bitmaps/tm_1_5.gif" ALT="other" BORDER="0" ALIGN=left></A>

	for(i = 0; i &lt; P; i++){
		data-&gt;state[i] = value;
	}
}

void swapChange(Data *data,int value){
	for(int i = 0; i &lt; P; i++){
		data-&gt;swap[i] = value;
	}
}

int add(int *data){
</FONT>	int flag = 0;
	for(int i = 0; i &lt; P; i++){
		flag += data[i];
	}
	return flag;
}


// even-odd pass bubbling from start to start+n

void bubble(Data *data, int start, int n, int pId)
{
	while(data-&gt;state[pId] != -1)
	{
		if(data-&gt;state[pId]){
			int swap_count = 0;
			int next = start;

			assert (start &lt; N-1); // bug if we start at the end of array

<A NAME="6"></A><FONT color = #00FF00><A HREF="match9-0.html#6" TARGET="0"><IMG SRC="http://moss.stanford.edu/bitmaps/tm_1_3.gif" ALT="other" BORDER="0" ALIGN=left></A>

			if (data-&gt;pass) { // sort odd-even index pairs
				if ( !(next % 2) )
					next = next + 1;
			} else  { // sort even-odd index pairs
				if (next % 2)
					next = next + 1;
			}

			while ( (next+1) &lt; (start+n) ) {
</FONT>				swap_count += compare_and_swap(data, next, next+1);
				next+=2;
			}
			data-&gt;swap[pId] = swap_count;
			data-&gt;state[pId] = 0;
	}
}
}



void parallel_sort(Data *data)
{
	int last_count, swap_count = N;
   do{
		last_count = swap_count;
		if( !add(data-&gt;state) ){
<A NAME="5"></A><FONT color = #FF0000><A HREF="match9-0.html#5" TARGET="0"><IMG SRC="http://moss.stanford.edu/bitmaps/tm_0_3.gif" ALT="other" BORDER="0" ALIGN=left></A>

			swap_count = add(data-&gt;swap);
			data-&gt;pass = 1 - data-&gt;pass;
			swapChange(data,  0);
			stateChange(data,  1);
		}
	} while((swap_count!=0) || (last_count != 0));
</FONT>	stateChange(data, -1);


}




int main(int argc, char *argv[])
{

	int status, shmid, mode;
	key_t key;

	if (argc != 3)
	{
<A NAME="2"></A><FONT color = #0000FF><A HREF="match9-0.html#2" TARGET="0"><IMG SRC="http://moss.stanford.edu/bitmaps/tm_2_5.gif" ALT="other" BORDER="0" ALIGN=left></A>

		fprintf(stderr, "Usage: %s N P\n", argv[0]);
		return 1;
	}

	 N = strtol(argv[1], (char **)NULL, 10);
	 P = strtol(argv[2], (char **)NULL, 10);
	if (N == 0)
</FONT>	{
		perror("Invalid N");
		return 2;
	}
	if (N &gt; MAX_COUNT)
	{
		fprintf(stderr, "N larger than %d.\n", MAX_COUNT);
		return 3;
	}

	if (P &lt; 2 || P &gt; MAX_P)
	{
		fprintf(stderr, "P Should be greater than 2 and less than 10");
	}

    int size;
    if (N % 2) {
        size = N / P + 1;
    } else {
        size = N / P;
	}


	Data *data;
    // Creating Shared Memory

<A NAME="4"></A><FONT color = #FF00FF><A HREF="match9-0.html#4" TARGET="0"><IMG SRC="http://moss.stanford.edu/bitmaps/tm_4_4.gif" ALT="other" BORDER="0" ALIGN=left></A>

	if ((key = ftok("test_shm", 'X')) &lt; 0)
	{
		perror("ftok");
		exit(1);
	}
	if ((shmid = shmget(key, sizeof(data), 0644 | IPC_CREAT  )) &lt; 0)
	{
		perror("shmget");
		exit(1);
	}
	data = (Data *)shmat(shmid, (void *)0, 0);
</FONT>	if (data == (Data *)(-1))
	{
		perror("shmat");
		exit(1);
	}
	else
	{
		data-&gt;pass = 0;
	    generate_numbers(data);
	    stateChange(data, 1);
	    swapChange(data, 0);
		printf("Before Sorting: \n");
		print_numbers(data);
		printf("\n");
	}

    //Creating P child Process.

	for (int i = 0; i &lt; P; i++)
	{
		int pid = fork();
		if (pid &lt; 0)
		{
			perror("fork failed:");
			exit(1);
		}

		else if (pid == 0)
		{
			printf("child created with id %d\n", getpid());
            bubble(data, i*(size-1), size, i);
			exit(0);


		}

		else if (pid &gt; 0)
		{
			printf("Parent id is %d \n", getppid(), pid);
		}

	}
	struct timeval stop, start;

    gettimeofday(&start, NULL);
    parallel_sort(data);
	gettimeofday(&stop, NULL);
	printf("After Sorting: \n");
    print_numbers(data);
	printf("\n");
	printf("Time taken to run %lu \n", (stop.tv_sec - start.tv_sec) * 1000000 + stop.tv_usec - start.tv_usec);
	shmdt(data);

	return 0;
}
</PRE>
</PRE>
</BODY>
</HTML>
